"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.dispatch = dispatch;
exports.subscribe = subscribe;
var targets = new WeakMap();

function getListeners(target) {
  var listeners = targets.get(target);

  if (!listeners) {
    listeners = new Set();
    targets.set(target, listeners);
  }

  return listeners;
}

var queue = new Set();

var run = function run(fn) {
  return fn();
};

function execute() {
  try {
    queue.forEach(function (target) {
      try {
        getListeners(target).forEach(run);
        queue.delete(target);
      } catch (e) {
        queue.delete(target);
        throw e;
      }
    });
  } catch (e) {
    if (queue.size) execute();
    throw e;
  }
}

function dispatch(target) {
  if (!queue.size) {
    requestAnimationFrame(execute);
  }

  queue.add(target);
}

function subscribe(target, cb) {
  var listeners = getListeners(target);
  listeners.add(cb);
  dispatch(target);
  return function () {
    return listeners.delete(cb);
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9lbWl0dGVyLmpzIl0sIm5hbWVzIjpbInRhcmdldHMiLCJXZWFrTWFwIiwiZ2V0TGlzdGVuZXJzIiwidGFyZ2V0IiwibGlzdGVuZXJzIiwiZ2V0IiwiU2V0Iiwic2V0IiwicXVldWUiLCJydW4iLCJmbiIsImV4ZWN1dGUiLCJmb3JFYWNoIiwiZGVsZXRlIiwiZSIsInNpemUiLCJkaXNwYXRjaCIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsImFkZCIsInN1YnNjcmliZSIsImNiIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUEsSUFBTUEsT0FBTyxHQUFHLElBQUlDLE9BQUosRUFBaEI7O0FBRUEsU0FBU0MsWUFBVCxDQUFzQkMsTUFBdEIsRUFBOEI7QUFDNUIsTUFBSUMsU0FBUyxHQUFHSixPQUFPLENBQUNLLEdBQVIsQ0FBWUYsTUFBWixDQUFoQjs7QUFDQSxNQUFJLENBQUNDLFNBQUwsRUFBZ0I7QUFDZEEsSUFBQUEsU0FBUyxHQUFHLElBQUlFLEdBQUosRUFBWjtBQUNBTixJQUFBQSxPQUFPLENBQUNPLEdBQVIsQ0FBWUosTUFBWixFQUFvQkMsU0FBcEI7QUFDRDs7QUFDRCxTQUFPQSxTQUFQO0FBQ0Q7O0FBRUQsSUFBTUksS0FBSyxHQUFHLElBQUlGLEdBQUosRUFBZDs7QUFDQSxJQUFNRyxHQUFHLEdBQUcsU0FBTkEsR0FBTSxDQUFBQyxFQUFFO0FBQUEsU0FBSUEsRUFBRSxFQUFOO0FBQUEsQ0FBZDs7QUFFQSxTQUFTQyxPQUFULEdBQW1CO0FBQ2pCLE1BQUk7QUFDRkgsSUFBQUEsS0FBSyxDQUFDSSxPQUFOLENBQWMsVUFBQ1QsTUFBRCxFQUFZO0FBQ3hCLFVBQUk7QUFDRkQsUUFBQUEsWUFBWSxDQUFDQyxNQUFELENBQVosQ0FBcUJTLE9BQXJCLENBQTZCSCxHQUE3QjtBQUNBRCxRQUFBQSxLQUFLLENBQUNLLE1BQU4sQ0FBYVYsTUFBYjtBQUNELE9BSEQsQ0FHRSxPQUFPVyxDQUFQLEVBQVU7QUFDVk4sUUFBQUEsS0FBSyxDQUFDSyxNQUFOLENBQWFWLE1BQWI7QUFDQSxjQUFNVyxDQUFOO0FBQ0Q7QUFDRixLQVJEO0FBU0QsR0FWRCxDQVVFLE9BQU9BLENBQVAsRUFBVTtBQUNWLFFBQUlOLEtBQUssQ0FBQ08sSUFBVixFQUFnQkosT0FBTztBQUN2QixVQUFNRyxDQUFOO0FBQ0Q7QUFDRjs7QUFFTSxTQUFTRSxRQUFULENBQWtCYixNQUFsQixFQUEwQjtBQUMvQixNQUFJLENBQUNLLEtBQUssQ0FBQ08sSUFBWCxFQUFpQjtBQUNmRSxJQUFBQSxxQkFBcUIsQ0FBQ04sT0FBRCxDQUFyQjtBQUNEOztBQUNESCxFQUFBQSxLQUFLLENBQUNVLEdBQU4sQ0FBVWYsTUFBVjtBQUNEOztBQUVNLFNBQVNnQixTQUFULENBQW1CaEIsTUFBbkIsRUFBMkJpQixFQUEzQixFQUErQjtBQUNwQyxNQUFNaEIsU0FBUyxHQUFHRixZQUFZLENBQUNDLE1BQUQsQ0FBOUI7QUFDQUMsRUFBQUEsU0FBUyxDQUFDYyxHQUFWLENBQWNFLEVBQWQ7QUFDQUosRUFBQUEsUUFBUSxDQUFDYixNQUFELENBQVI7QUFFQSxTQUFPO0FBQUEsV0FBTUMsU0FBUyxDQUFDUyxNQUFWLENBQWlCTyxFQUFqQixDQUFOO0FBQUEsR0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgdGFyZ2V0cyA9IG5ldyBXZWFrTWFwKCk7XG5cbmZ1bmN0aW9uIGdldExpc3RlbmVycyh0YXJnZXQpIHtcbiAgbGV0IGxpc3RlbmVycyA9IHRhcmdldHMuZ2V0KHRhcmdldCk7XG4gIGlmICghbGlzdGVuZXJzKSB7XG4gICAgbGlzdGVuZXJzID0gbmV3IFNldCgpO1xuICAgIHRhcmdldHMuc2V0KHRhcmdldCwgbGlzdGVuZXJzKTtcbiAgfVxuICByZXR1cm4gbGlzdGVuZXJzO1xufVxuXG5jb25zdCBxdWV1ZSA9IG5ldyBTZXQoKTtcbmNvbnN0IHJ1biA9IGZuID0+IGZuKCk7XG5cbmZ1bmN0aW9uIGV4ZWN1dGUoKSB7XG4gIHRyeSB7XG4gICAgcXVldWUuZm9yRWFjaCgodGFyZ2V0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBnZXRMaXN0ZW5lcnModGFyZ2V0KS5mb3JFYWNoKHJ1bik7XG4gICAgICAgIHF1ZXVlLmRlbGV0ZSh0YXJnZXQpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBxdWV1ZS5kZWxldGUodGFyZ2V0KTtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmIChxdWV1ZS5zaXplKSBleGVjdXRlKCk7XG4gICAgdGhyb3cgZTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGlzcGF0Y2godGFyZ2V0KSB7XG4gIGlmICghcXVldWUuc2l6ZSkge1xuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShleGVjdXRlKTtcbiAgfVxuICBxdWV1ZS5hZGQodGFyZ2V0KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN1YnNjcmliZSh0YXJnZXQsIGNiKSB7XG4gIGNvbnN0IGxpc3RlbmVycyA9IGdldExpc3RlbmVycyh0YXJnZXQpO1xuICBsaXN0ZW5lcnMuYWRkKGNiKTtcbiAgZGlzcGF0Y2godGFyZ2V0KTtcblxuICByZXR1cm4gKCkgPT4gbGlzdGVuZXJzLmRlbGV0ZShjYik7XG59XG4iXX0=