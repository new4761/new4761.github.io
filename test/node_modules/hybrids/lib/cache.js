"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getEntry = getEntry;
exports.get = get;
exports.set = set;
exports.invalidate = invalidate;
exports.observe = observe;

var _utils = require("./utils");

var emitter = _interopRequireWildcard(require("./emitter"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

var entries = new WeakMap();

function getEntry(target, key) {
  var targetMap = entries.get(target);

  if (!targetMap) {
    targetMap = new Map();
    entries.set(target, targetMap);
  }

  var entry = targetMap.get(key);

  if (!entry) {
    entry = {
      target: target,
      key: key,
      value: undefined,
      contexts: undefined,
      deps: undefined,
      state: 1,
      checksum: 0,
      observed: false
    };
    targetMap.set(key, entry);
  }

  return entry;
}

function calculateChecksum(entry) {
  var checksum = entry.state;

  if (entry.deps) {
    entry.deps.forEach(function (depEntry) {
      // eslint-disable-next-line no-unused-expressions
      depEntry.target[depEntry.key];
      checksum += depEntry.state;
    });
  }

  return checksum;
}

function dispatchDeep(entry) {
  if (entry.observed) emitter.dispatch(entry);
  if (entry.contexts) entry.contexts.forEach(dispatchDeep);
}

var context = null;

function get(target, key, getter) {
  var entry = getEntry(target, key);

  if (context === entry) {
    context = null;
    throw Error("Circular '".concat(key, "' get invocation in '").concat((0, _utils.stringifyElement)(target), "'"));
  }

  if (context) {
    context.deps = context.deps || new Set();
    context.deps.add(entry);
  }

  if (context && (context.observed || context.contexts && context.contexts.size)) {
    entry.contexts = entry.contexts || new Set();
    entry.contexts.add(context);
  }

  var parentContext = context;
  context = entry;

  if (entry.checksum && entry.checksum === calculateChecksum(entry)) {
    context = parentContext;
    return entry.value;
  }

  if (entry.deps && entry.deps.size) {
    entry.deps.forEach(function (depEntry) {
      if (depEntry.contexts) depEntry.contexts.delete(entry);
    });
    entry.deps = undefined;
  }

  try {
    var nextValue = getter(target, entry.value);

    if (nextValue !== entry.value) {
      entry.state += 1;
      entry.value = nextValue;
      dispatchDeep(entry);
    }

    entry.checksum = calculateChecksum(entry);
    context = parentContext;
  } catch (e) {
    context = null;
    throw e;
  }

  return entry.value;
}

function set(target, key, setter, value) {
  if (context) {
    context = null;
    throw Error("Try to set '".concat(key, "' of '").concat((0, _utils.stringifyElement)(target), "' in get call"));
  }

  var entry = getEntry(target, key);
  var newValue = setter(target, value, entry.value);

  if (newValue !== entry.value) {
    entry.state += 1;
    entry.value = newValue;
    dispatchDeep(entry);
  }
}

function invalidate(target, key, clearValue) {
  if (context) {
    context = null;
    throw Error("Try to invalidate '".concat(key, "' in '").concat((0, _utils.stringifyElement)(target), "' get call"));
  }

  var entry = getEntry(target, key);
  entry.checksum = 0;
  dispatchDeep(entry);

  if (clearValue) {
    entry.value = undefined;
  }
}

function observe(target, key, fn) {
  var entry = getEntry(target, key);
  entry.observed = true;
  return emitter.subscribe(entry, fn);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWNoZS5qcyJdLCJuYW1lcyI6WyJlbnRyaWVzIiwiV2Vha01hcCIsImdldEVudHJ5IiwidGFyZ2V0Iiwia2V5IiwidGFyZ2V0TWFwIiwiZ2V0IiwiTWFwIiwic2V0IiwiZW50cnkiLCJ2YWx1ZSIsInVuZGVmaW5lZCIsImNvbnRleHRzIiwiZGVwcyIsInN0YXRlIiwiY2hlY2tzdW0iLCJvYnNlcnZlZCIsImNhbGN1bGF0ZUNoZWNrc3VtIiwiZm9yRWFjaCIsImRlcEVudHJ5IiwiZGlzcGF0Y2hEZWVwIiwiZW1pdHRlciIsImRpc3BhdGNoIiwiY29udGV4dCIsImdldHRlciIsIkVycm9yIiwiU2V0IiwiYWRkIiwic2l6ZSIsInBhcmVudENvbnRleHQiLCJkZWxldGUiLCJuZXh0VmFsdWUiLCJlIiwic2V0dGVyIiwibmV3VmFsdWUiLCJpbnZhbGlkYXRlIiwiY2xlYXJWYWx1ZSIsIm9ic2VydmUiLCJmbiIsInN1YnNjcmliZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQUVBLElBQU1BLE9BQU8sR0FBRyxJQUFJQyxPQUFKLEVBQWhCOztBQUNPLFNBQVNDLFFBQVQsQ0FBa0JDLE1BQWxCLEVBQTBCQyxHQUExQixFQUErQjtBQUNwQyxNQUFJQyxTQUFTLEdBQUdMLE9BQU8sQ0FBQ00sR0FBUixDQUFZSCxNQUFaLENBQWhCOztBQUNBLE1BQUksQ0FBQ0UsU0FBTCxFQUFnQjtBQUNkQSxJQUFBQSxTQUFTLEdBQUcsSUFBSUUsR0FBSixFQUFaO0FBQ0FQLElBQUFBLE9BQU8sQ0FBQ1EsR0FBUixDQUFZTCxNQUFaLEVBQW9CRSxTQUFwQjtBQUNEOztBQUVELE1BQUlJLEtBQUssR0FBR0osU0FBUyxDQUFDQyxHQUFWLENBQWNGLEdBQWQsQ0FBWjs7QUFFQSxNQUFJLENBQUNLLEtBQUwsRUFBWTtBQUNWQSxJQUFBQSxLQUFLLEdBQUc7QUFDTk4sTUFBQUEsTUFBTSxFQUFOQSxNQURNO0FBRU5DLE1BQUFBLEdBQUcsRUFBSEEs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S0FBdkIsRUFBOEI7QUFDNUJELElBQUFBLEtBQUssQ0FBQ0ssS0FBTixJQUFlLENBQWY7QUFDQUwsSUFBQUEsS0FBSyxDQUFDQyxLQUFOLEdBQWN3QixRQUFkO0FBRUFkLElBQUFBLFlBQVksQ0FBQ1gsS0FBRCxDQUFaO0FBQ0Q7QUFDRjs7QUFFTSxTQUFTMEIsVUFBVCxDQUFvQmhDLE1BQXBCLEVBQTRCQyxHQUE1QixFQUFpQ2dDLFVBQWpDLEVBQTZDO0FBQ2xELE1BQUliLE9BQUosRUFBYTtBQUNYQSxJQUFBQSxPQUFPLEdBQUcsSUFBVjtBQUNBLFVBQU1FLEtBQUssOEJBQXVCckIsR0FBdkIsbUJBQW1DLDZCQUFpQkQsTUFBakIsQ0FBbkMsZ0JBQVg7QUFDRDs7QUFFRCxNQUFNTSxLQUFLLEdBQUdQLFFBQVEsQ0FBQ0MsTUFBRCxFQUFTQyxHQUFULENBQXRCO0FBRUFLLEVBQUFBLEtBQUssQ0FBQ00sUUFBTixHQUFpQixDQUFqQjtBQUNBSyxFQUFBQSxZQUFZLENBQUNYLEtBQUQsQ0FBWjs7QUFFQSxNQUFJMkIsVUFBSixFQUFnQjtBQUNkM0IsSUFBQUEsS0FBSyxDQUFDQyxLQUFOLEdBQWNDLFNBQWQ7QUFDRDtBQUNGOztBQUVNLFNBQVMwQixPQUFULENBQWlCbEMsTUFBakIsRUFBeUJDLEdBQXpCLEVBQThCa0MsRUFBOUIsRUFBa0M7QUFDdkMsTUFBTTdCLEtBQUssR0FBR1AsUUFBUSxDQUFDQyxNQUFELEVBQVNDLEdBQVQsQ0FBdEI7QUFDQUssRUFBQUEsS0FBSyxDQUFDTyxRQUFOLEdBQWlCLElBQWpCO0FBQ0EsU0FBT0ssT0FBTyxDQUFDa0IsU0FBUixDQUFrQjlCLEtBQWxCLEVBQXlCNkIsRUFBekIsQ0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc3RyaW5naWZ5RWxlbWVudCB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0ICogYXMgZW1pdHRlciBmcm9tICcuL2VtaXR0ZXInO1xuXG5jb25zdCBlbnRyaWVzID0gbmV3IFdlYWtNYXAoKTtcbmV4cG9ydCBmdW5jdGlvbiBnZXRFbnRyeSh0YXJnZXQsIGtleSkge1xuICBsZXQgdGFyZ2V0TWFwID0gZW50cmllcy5nZXQodGFyZ2V0KTtcbiAgaWYgKCF0YXJnZXRNYXApIHtcbiAgICB0YXJnZXRNYXAgPSBuZXcgTWFwKCk7XG4gICAgZW50cmllcy5zZXQodGFyZ2V0LCB0YXJnZXRNYXApO1xuICB9XG5cbiAgbGV0IGVudHJ5ID0gdGFyZ2V0TWFwLmdldChrZXkpO1xuXG4gIGlmICghZW50cnkpIHtcbiAgICBlbnRyeSA9IHtcbiAgICAgIHRhcmdldCxcbiAgICAgIGtleSxcbiAgICAgIHZhbHVlOiB1bmRlZmluZWQsXG4gICAgICBjb250ZXh0czogdW5kZWZpbmVkLFxuICAgICAgZGVwczogdW5kZWZpbmVkLFxuICAgICAgc3RhdGU6IDEsXG4gICAgICBjaGVja3N1bTogMCxcbiAgICAgIG9ic2VydmVkOiBmYWxzZSxcbiAgICB9O1xuICAgIHRhcmdldE1hcC5zZXQoa2V5LCBlbnRyeSk7XG4gIH1cblxuICByZXR1cm4gZW50cnk7XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZUNoZWNrc3VtKGVudHJ5KSB7XG4gIGxldCBjaGVja3N1bSA9IGVudHJ5LnN0YXRlO1xuICBpZiAoZW50cnkuZGVwcykge1xuICAgIGVudHJ5LmRlcHMuZm9yRWFjaCgoZGVwRW50cnkpID0+IHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtZXhwcmVzc2lvbnNcbiAgICAgIGRlcEVudHJ5LnRhcmdldFtkZXBFbnRyeS5rZXldO1xuICAgICAgY2hlY2tzdW0gKz0gZGVwRW50cnkuc3RhdGU7XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gY2hlY2tzdW07XG59XG5cbmZ1bmN0aW9uIGRpc3BhdGNoRGVlcChlbnRyeSkge1xuICBpZiAoZW50cnkub2JzZXJ2ZWQpIGVtaXR0ZXIuZGlzcGF0Y2goZW50cnkpO1xuICBpZiAoZW50cnkuY29udGV4dHMpIGVudHJ5LmNvbnRleHRzLmZvckVhY2goZGlzcGF0Y2hEZWVwKTtcbn1cblxubGV0IGNvbnRleHQgPSBudWxsO1xuZXhwb3J0IGZ1bmN0aW9uIGdldCh0YXJnZXQsIGtleSwgZ2V0dGVyKSB7XG4gIGNvbnN0IGVudHJ5ID0gZ2V0RW50cnkodGFyZ2V0LCBrZXkpO1xuXG4gIGlmIChjb250ZXh0ID09PSBlbnRyeSkge1xuICAgIGNvbnRleHQgPSBudWxsO1xuICAgIHRocm93IEVycm9yKGBDaXJjdWxhciAnJHtrZXl9JyBnZXQgaW52b2NhdGlvbiBpbiAnJHtzdHJpbmdpZnlFbGVtZW50KHRhcmdldCl9J2ApO1xuICB9XG5cbiAgaWYgKGNvbnRleHQpIHtcbiAgICBjb250ZXh0LmRlcHMgPSBjb250ZXh0LmRlcHMgfHwgbmV3IFNldCgpO1xuICAgIGNvbnRleHQuZGVwcy5hZGQoZW50cnkpO1xuICB9XG5cbiAgaWYgKGNvbnRleHQgJiYgKGNvbnRleHQub2JzZXJ2ZWQgfHwgKGNvbnRleHQuY29udGV4dHMgJiYgY29udGV4dC5jb250ZXh0cy5zaXplKSkpIHtcbiAgICBlbnRyeS5jb250ZXh0cyA9IGVudHJ5LmNvbnRleHRzIHx8IG5ldyBTZXQoKTtcbiAgICBlbnRyeS5jb250ZXh0cy5hZGQoY29udGV4dCk7XG4gIH1cblxuICBjb25zdCBwYXJlbnRDb250ZXh0ID0gY29udGV4dDtcbiAgY29udGV4dCA9IGVudHJ5O1xuXG4gIGlmIChlbnRyeS5jaGVja3N1bSAmJiBlbnRyeS5jaGVja3N1bSA9PT0gY2FsY3VsYXRlQ2hlY2tzdW0oZW50cnkpKSB7XG4gICAgY29udGV4dCA9IHBhcmVudENvbnRleHQ7XG4gICAgcmV0dXJuIGVudHJ5LnZhbHVlO1xuICB9XG5cbiAgaWYgKGVudHJ5LmRlcHMgJiYgZW50cnkuZGVwcy5zaXplKSB7XG4gICAgZW50cnkuZGVwcy5mb3JFYWNoKChkZXBFbnRyeSkgPT4ge1xuICAgICAgaWYgKGRlcEVudHJ5LmNvbnRleHRzKSBkZXBFbnRyeS5jb250ZXh0cy5kZWxldGUoZW50cnkpO1xuICAgIH0pO1xuICAgIGVudHJ5LmRlcHMgPSB1bmRlZmluZWQ7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IG5leHRWYWx1ZSA9IGdldHRlcih0YXJnZXQsIGVudHJ5LnZhbHVlKTtcblxuICAgIGlmIChuZXh0VmFsdWUgIT09IGVudHJ5LnZhbHVlKSB7XG4gICAgICBlbnRyeS5zdGF0ZSArPSAxO1xuICAgICAgZW50cnkudmFsdWUgPSBuZXh0VmFsdWU7XG5cbiAgICAgIGRpc3BhdGNoRGVlcChlbnRyeSk7XG4gICAgfVxuXG4gICAgZW50cnkuY2hlY2tzdW0gPSBjYWxjdWxhdGVDaGVja3N1bShlbnRyeSk7XG4gICAgY29udGV4dCA9IHBhcmVudENvbnRleHQ7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBjb250ZXh0ID0gbnVsbDtcbiAgICB0aHJvdyBlO1xuICB9XG5cbiAgcmV0dXJuIGVudHJ5LnZhbHVlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0KHRhcmdldCwga2V5LCBzZXR0ZXIsIHZhbHVlKSB7XG4gIGlmIChjb250ZXh0KSB7XG4gICAgY29udGV4dCA9IG51bGw7XG4gICAgdGhyb3cgRXJyb3IoYFRyeSB0byBzZXQgJyR7a2V5fScgb2YgJyR7c3RyaW5naWZ5RWxlbWVudCh0YXJnZXQpfScgaW4gZ2V0IGNhbGxgKTtcbiAgfVxuXG4gIGNvbnN0IGVudHJ5ID0gZ2V0RW50cnkodGFyZ2V0LCBrZXkpO1xuICBjb25zdCBuZXdWYWx1ZSA9IHNldHRlcih0YXJnZXQsIHZhbHVlLCBlbnRyeS52YWx1ZSk7XG5cbiAgaWYgKG5ld1ZhbHVlICE9PSBlbnRyeS52YWx1ZSkge1xuICAgIGVudHJ5LnN0YXRlICs9IDE7XG4gICAgZW50cnkudmFsdWUgPSBuZXdWYWx1ZTtcblxuICAgIGRpc3BhdGNoRGVlcChlbnRyeSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGludmFsaWRhdGUodGFyZ2V0LCBrZXksIGNsZWFyVmFsdWUpIHtcbiAgaWYgKGNvbnRleHQpIHtcbiAgICBjb250ZXh0ID0gbnVsbDtcbiAgICB0aHJvdyBFcnJvcihgVHJ5IHRvIGludmFsaWRhdGUgJyR7a2V5fScgaW4gJyR7c3RyaW5naWZ5RWxlbWVudCh0YXJnZXQpfScgZ2V0IGNhbGxgKTtcbiAgfVxuXG4gIGNvbnN0IGVudHJ5ID0gZ2V0RW50cnkodGFyZ2V0LCBrZXkpO1xuXG4gIGVudHJ5LmNoZWNrc3VtID0gMDtcbiAgZGlzcGF0Y2hEZWVwKGVudHJ5KTtcblxuICBpZiAoY2xlYXJWYWx1ZSkge1xuICAgIGVudHJ5LnZhbHVlID0gdW5kZWZpbmVkO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBvYnNlcnZlKHRhcmdldCwga2V5LCBmbikge1xuICBjb25zdCBlbnRyeSA9IGdldEVudHJ5KHRhcmdldCwga2V5KTtcbiAgZW50cnkub2JzZXJ2ZWQgPSB0cnVlO1xuICByZXR1cm4gZW1pdHRlci5zdWJzY3JpYmUoZW50cnksIGZuKTtcbn1cbiJdfQ==