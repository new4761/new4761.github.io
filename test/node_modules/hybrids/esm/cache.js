import { stringifyElement } from './utils';
import * as emitter from './emitter';
var entries = new WeakMap();
export function getEntry(target, key) {
  var targetMap = entries.get(target);

  if (!targetMap) {
    targetMap = new Map();
    entries.set(target, targetMap);
  }

  var entry = targetMap.get(key);

  if (!entry) {
    entry = {
      target: target,
      key: key,
      value: undefined,
      contexts: undefined,
      deps: undefined,
      state: 1,
      checksum: 0,
      observed: false
    };
    targetMap.set(key, entry);
  }

  return entry;
}

function calculateChecksum(entry) {
  var checksum = entry.state;

  if (entry.deps) {
    entry.deps.forEach(function (depEntry) {
      // eslint-disable-next-line no-unused-expressions
      depEntry.target[depEntry.key];
      checksum += depEntry.state;
    });
  }

  return checksum;
}

function dispatchDeep(entry) {
  if (entry.observed) emitter.dispatch(entry);
  if (entry.contexts) entry.contexts.forEach(dispatchDeep);
}

var context = null;
export function get(target, key, getter) {
  var entry = getEntry(target, key);

  if (context === entry) {
    context = null;
    throw Error("Circular '".concat(key, "' get invocation in '").concat(stringifyElement(target), "'"));
  }

  if (context) {
    context.deps = context.deps || new Set();
    context.deps.add(entry);
  }

  if (context && (context.observed || context.contexts && context.contexts.size)) {
    entry.contexts = entry.contexts || new Set();
    entry.contexts.add(context);
  }

  var parentContext = context;
  context = entry;

  if (entry.checksum && entry.checksum === calculateChecksum(entry)) {
    context = parentContext;
    return entry.value;
  }

  if (entry.deps && entry.deps.size) {
    entry.deps.forEach(function (depEntry) {
      if (depEntry.contexts) depEntry.contexts.delete(entry);
    });
    entry.deps = undefined;
  }

  try {
    var nextValue = getter(target, entry.value);

    if (nextValue !== entry.value) {
      entry.state += 1;
      entry.value = nextValue;
      dispatchDeep(entry);
    }

    entry.checksum = calculateChecksum(entry);
    context = parentContext;
  } catch (e) {
    context = null;
    throw e;
  }

  return entry.value;
}
export function set(target, key, setter, value) {
  if (context) {
    context = null;
    throw Error("Try to set '".concat(key, "' of '").concat(stringifyElement(target), "' in get call"));
  }

  var entry = getEntry(target, key);
  var newValue = setter(target, value, entry.value);

  if (newValue !== entry.value) {
    entry.state += 1;
    entry.value = newValue;
    dispatchDeep(entry);
  }
}
export function invalidate(target, key, clearValue) {
  if (context) {
    context = null;
    throw Error("Try to invalidate '".concat(key, "' in '").concat(stringifyElement(target), "' get call"));
  }

  var entry = getEntry(target, key);
  entry.checksum = 0;
  dispatchDeep(entry);

  if (clearValue) {
    entry.value = undefined;
  }
}
export function observe(target, key, fn) {
  var entry = getEntry(target, key);
  entry.observed = true;
  return emitter.subscribe(entry, fn);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWNoZS5qcyJdLCJuYW1lcyI6WyJzdHJpbmdpZnlFbGVtZW50IiwiZW1pdHRlciIsImVudHJpZXMiLCJXZWFrTWFwIiwiZ2V0RW50cnkiLCJ0YXJnZXQiLCJrZXkiLCJ0YXJnZXRNYXAiLCJnZXQiLCJNYXAiLCJzZXQiLCJlbnRyeSIsInZhbHVlIiwidW5kZWZpbmVkIiwiY29udGV4dHMiLCJkZXBzIiwic3RhdGUiLCJjaGVja3N1bSIsIm9ic2VydmVkIiwiY2FsY3VsYXRlQ2hlY2tzdW0iLCJmb3JFYWNoIiwiZGVwRW50cnkiLCJkaXNwYXRjaERlZXAiLCJkaXNwYXRjaCIsImNvbnRleHQiLCJnZXR0ZXIiLCJFcnJvciIsIlNldCIsImFkZCIsInNpemUiLCJwYXJlbnRDb250ZXh0IiwiZGVsZXRlIiwibmV4dFZhbHVlIiwiZSIsInNldHRlciIsIm5ld1ZhbHVlIiwiaW52YWxpZGF0ZSIsImNsZWFyVmFsdWUiLCJvYnNlcnZlIiwiZm4iLCJzdWJzY3JpYmUiXSwibWFwcGluZ3MiOiJBQUFBLFNBQVNBLGdCQUFULFFBQWlDLFNBQWpDO0FBQ0EsT0FBTyxLQUFLQyxPQUFaLE1BQXlCLFdBQXpCO0FBRUEsSUFBTUMsT0FBTyxHQUFHLElBQUlDLE9BQUosRUFBaEI7QUFDQSxPQUFPLFNBQVNDLFFBQVQsQ0FBa0JDLE1BQWxCLEVBQTBCQyxHQUExQixFQUErQjtBQUNwQyxNQUFJQyxTQUFTLEdBQUdMLE9BQU8sQ0FBQ00sR0FBUixDQUFZSCxNQUFaLENBQWhCOztBQUNBLE1BQUksQ0FBQ0UsU0FBTCxFQUFnQjtBQUNkQSxJQUFBQSxTQUFTLEdBQUcsSUFBSUUsR0FBSixFQUFaO0FBQ0FQLElBQUFBLE9BQU8sQ0FBQ1EsR0FBUixDQUFZTCxNQUFaLEVBQW9CRSxTQUFwQjtBQUNEOztBQUVELE1BQUlJLEtBQUssR0FBR0osU0FBUyxDQUFDQyxHQUFWLENBQWNGLEdBQWQsQ0FBWjs7QUFFQSxNQUFJLENBQUNLLEtBQUwsRUFBWTtBQUNWQSxJQUFBQSxL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bHMnO1xuaW1wb3J0ICogYXMgZW1pdHRlciBmcm9tICcuL2VtaXR0ZXInO1xuXG5jb25zdCBlbnRyaWVzID0gbmV3IFdlYWtNYXAoKTtcbmV4cG9ydCBmdW5jdGlvbiBnZXRFbnRyeSh0YXJnZXQsIGtleSkge1xuICBsZXQgdGFyZ2V0TWFwID0gZW50cmllcy5nZXQodGFyZ2V0KTtcbiAgaWYgKCF0YXJnZXRNYXApIHtcbiAgICB0YXJnZXRNYXAgPSBuZXcgTWFwKCk7XG4gICAgZW50cmllcy5zZXQodGFyZ2V0LCB0YXJnZXRNYXApO1xuICB9XG5cbiAgbGV0IGVudHJ5ID0gdGFyZ2V0TWFwLmdldChrZXkpO1xuXG4gIGlmICghZW50cnkpIHtcbiAgICBlbnRyeSA9IHtcbiAgICAgIHRhcmdldCxcbiAgICAgIGtleSxcbiAgICAgIHZhbHVlOiB1bmRlZmluZWQsXG4gICAgICBjb250ZXh0czogdW5kZWZpbmVkLFxuICAgICAgZGVwczogdW5kZWZpbmVkLFxuICAgICAgc3RhdGU6IDEsXG4gICAgICBjaGVja3N1bTogMCxcbiAgICAgIG9ic2VydmVkOiBmYWxzZSxcbiAgICB9O1xuICAgIHRhcmdldE1hcC5zZXQoa2V5LCBlbnRyeSk7XG4gIH1cblxuICByZXR1cm4gZW50cnk7XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZUNoZWNrc3VtKGVudHJ5KSB7XG4gIGxldCBjaGVja3N1bSA9IGVudHJ5LnN0YXRlO1xuICBpZiAoZW50cnkuZGVwcykge1xuICAgIGVudHJ5LmRlcHMuZm9yRWFjaCgoZGVwRW50cnkpID0+IHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtZXhwcmVzc2lvbnNcbiAgICAgIGRlcEVudHJ5LnRhcmdldFtkZXBFbnRyeS5rZXldO1xuICAgICAgY2hlY2tzdW0gKz0gZGVwRW50cnkuc3RhdGU7XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gY2hlY2tzdW07XG59XG5cbmZ1bmN0aW9uIGRpc3BhdGNoRGVlcChlbnRyeSkge1xuICBpZiAoZW50cnkub2JzZXJ2ZWQpIGVtaXR0ZXIuZGlzcGF0Y2goZW50cnkpO1xuICBpZiAoZW50cnkuY29udGV4dHMpIGVudHJ5LmNvbnRleHRzLmZvckVhY2goZGlzcGF0Y2hEZWVwKTtcbn1cblxubGV0IGNvbnRleHQgPSBudWxsO1xuZXhwb3J0IGZ1bmN0aW9uIGdldCh0YXJnZXQsIGtleSwgZ2V0dGVyKSB7XG4gIGNvbnN0IGVudHJ5ID0gZ2V0RW50cnkodGFyZ2V0LCBrZXkpO1xuXG4gIGlmIChjb250ZXh0ID09PSBlbnRyeSkge1xuICAgIGNvbnRleHQgPSBudWxsO1xuICAgIHRocm93IEVycm9yKGBDaXJjdWxhciAnJHtrZXl9JyBnZXQgaW52b2NhdGlvbiBpbiAnJHtzdHJpbmdpZnlFbGVtZW50KHRhcmdldCl9J2ApO1xuICB9XG5cbiAgaWYgKGNvbnRleHQpIHtcbiAgICBjb250ZXh0LmRlcHMgPSBjb250ZXh0LmRlcHMgfHwgbmV3IFNldCgpO1xuICAgIGNvbnRleHQuZGVwcy5hZGQoZW50cnkpO1xuICB9XG5cbiAgaWYgKGNvbnRleHQgJiYgKGNvbnRleHQub2JzZXJ2ZWQgfHwgKGNvbnRleHQuY29udGV4dHMgJiYgY29udGV4dC5jb250ZXh0cy5zaXplKSkpIHtcbiAgICBlbnRyeS5jb250ZXh0cyA9IGVudHJ5LmNvbnRleHRzIHx8IG5ldyBTZXQoKTtcbiAgICBlbnRyeS5jb250ZXh0cy5hZGQoY29udGV4dCk7XG4gIH1cblxuICBjb25zdCBwYXJlbnRDb250ZXh0ID0gY29udGV4dDtcbiAgY29udGV4dCA9IGVudHJ5O1xuXG4gIGlmIChlbnRyeS5jaGVja3N1bSAmJiBlbnRyeS5jaGVja3N1bSA9PT0gY2FsY3VsYXRlQ2hlY2tzdW0oZW50cnkpKSB7XG4gICAgY29udGV4dCA9IHBhcmVudENvbnRleHQ7XG4gICAgcmV0dXJuIGVudHJ5LnZhbHVlO1xuICB9XG5cbiAgaWYgKGVudHJ5LmRlcHMgJiYgZW50cnkuZGVwcy5zaXplKSB7XG4gICAgZW50cnkuZGVwcy5mb3JFYWNoKChkZXBFbnRyeSkgPT4ge1xuICAgICAgaWYgKGRlcEVudHJ5LmNvbnRleHRzKSBkZXBFbnRyeS5jb250ZXh0cy5kZWxldGUoZW50cnkpO1xuICAgIH0pO1xuICAgIGVudHJ5LmRlcHMgPSB1bmRlZmluZWQ7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IG5leHRWYWx1ZSA9IGdldHRlcih0YXJnZXQsIGVudHJ5LnZhbHVlKTtcblxuICAgIGlmIChuZXh0VmFsdWUgIT09IGVudHJ5LnZhbHVlKSB7XG4gICAgICBlbnRyeS5zdGF0ZSArPSAxO1xuICAgICAgZW50cnkudmFsdWUgPSBuZXh0VmFsdWU7XG5cbiAgICAgIGRpc3BhdGNoRGVlcChlbnRyeSk7XG4gICAgfVxuXG4gICAgZW50cnkuY2hlY2tzdW0gPSBjYWxjdWxhdGVDaGVja3N1bShlbnRyeSk7XG4gICAgY29udGV4dCA9IHBhcmVudENvbnRleHQ7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBjb250ZXh0ID0gbnVsbDtcbiAgICB0aHJvdyBlO1xuICB9XG5cbiAgcmV0dXJuIGVudHJ5LnZhbHVlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0KHRhcmdldCwga2V5LCBzZXR0ZXIsIHZhbHVlKSB7XG4gIGlmIChjb250ZXh0KSB7XG4gICAgY29udGV4dCA9IG51bGw7XG4gICAgdGhyb3cgRXJyb3IoYFRyeSB0byBzZXQgJyR7a2V5fScgb2YgJyR7c3RyaW5naWZ5RWxlbWVudCh0YXJnZXQpfScgaW4gZ2V0IGNhbGxgKTtcbiAgfVxuXG4gIGNvbnN0IGVudHJ5ID0gZ2V0RW50cnkodGFyZ2V0LCBrZXkpO1xuICBjb25zdCBuZXdWYWx1ZSA9IHNldHRlcih0YXJnZXQsIHZhbHVlLCBlbnRyeS52YWx1ZSk7XG5cbiAgaWYgKG5ld1ZhbHVlICE9PSBlbnRyeS52YWx1ZSkge1xuICAgIGVudHJ5LnN0YXRlICs9IDE7XG4gICAgZW50cnkudmFsdWUgPSBuZXdWYWx1ZTtcblxuICAgIGRpc3BhdGNoRGVlcChlbnRyeSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGludmFsaWRhdGUodGFyZ2V0LCBrZXksIGNsZWFyVmFsdWUpIHtcbiAgaWYgKGNvbnRleHQpIHtcbiAgICBjb250ZXh0ID0gbnVsbDtcbiAgICB0aHJvdyBFcnJvcihgVHJ5IHRvIGludmFsaWRhdGUgJyR7a2V5fScgaW4gJyR7c3RyaW5naWZ5RWxlbWVudCh0YXJnZXQpfScgZ2V0IGNhbGxgKTtcbiAgfVxuXG4gIGNvbnN0IGVudHJ5ID0gZ2V0RW50cnkodGFyZ2V0LCBrZXkpO1xuXG4gIGVudHJ5LmNoZWNrc3VtID0gMDtcbiAgZGlzcGF0Y2hEZWVwKGVudHJ5KTtcblxuICBpZiAoY2xlYXJWYWx1ZSkge1xuICAgIGVudHJ5LnZhbHVlID0gdW5kZWZpbmVkO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBvYnNlcnZlKHRhcmdldCwga2V5LCBmbikge1xuICBjb25zdCBlbnRyeSA9IGdldEVudHJ5KHRhcmdldCwga2V5KTtcbiAgZW50cnkub2JzZXJ2ZWQgPSB0cnVlO1xuICByZXR1cm4gZW1pdHRlci5zdWJzY3JpYmUoZW50cnksIGZuKTtcbn1cbiJdfQ==