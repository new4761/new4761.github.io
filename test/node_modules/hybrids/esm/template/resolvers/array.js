import { dataMap, removeTemplate, getTemplateEnd } from '../utils'; // eslint-disable-next-line import/no-cycle

import resolveValue from './value';
export var arrayMap = new WeakMap();

function movePlaceholder(target, previousSibling) {
  var data = dataMap.get(target);
  var startNode = data.startNode;
  var endNode = getTemplateEnd(data.endNode);
  previousSibling.parentNode.insertBefore(target, previousSibling.nextSibling);
  var prevNode = target;
  var node = startNode;

  while (node) {
    var nextNode = node.nextSibling;
    prevNode.parentNode.insertBefore(node, prevNode.nextSibling);
    prevNode = node;
    node = nextNode !== endNode.nextSibling && nextNode;
  }
}

export default function resolveArray(host, target, value) {
  var lastEntries = arrayMap.get(target);
  var entries = value.map(function (item, index) {
    return {
      id: Object.prototype.hasOwnProperty.call(item, 'id') ? item.id : index,
      value: item,
      placeholder: null,
      available: true
    };
  });
  arrayMap.set(target, entries);

  if (lastEntries) {
    var ids = new Set();
    entries.forEach(function (entry) {
      return ids.add(entry.id);
    });
    lastEntries = lastEntries.filter(function (entry) {
      if (!ids.has(entry.id)) {
        removeTemplate(entry.placeholder);
        entry.placeholder.parentNode.removeChild(entry.placeholder);
        return false;
      }

      return true;
    });
  }

  var previousSibling = target;
  var lastIndex = value.length - 1;
  var data = dataMap.get(target);

  for (var index = 0; index < entries.length; index += 1) {
    var entry = entries[index];
    var matchedEntry = void 0;

    if (lastEntries) {
      for (var i = 0; i < lastEntries.length; i += 1) {
        if (lastEntries[i].available && lastEntries[i].id === entry.id) {
          matchedEntry = lastEntries[i];
          break;
        }
      }
    }

    var placeholder = void 0;

    if (matchedEntry) {
      matchedEntry.available = false;
      placeholder = matchedEntry.placeholder;

      if (placeholder.previousSibling !== previousSibling) {
        movePlaceholder(placeholder, previousSibling);
      }

      if (matchedEntry.value !== entry.value) {
        resolveValue(host, placeholder, entry.value);
      }
    } else {
      placeholder = document.createTextNode('');
      previousSibling.parentNode.insertBefore(placeholder, previousSibling.nextSibling);
      resolveValue(host, placeholder, entry.value);
    }

    previousSibling = getTemplateEnd(dataMap.get(placeholder).endNode || placeholder);
    if (index === 0) data.startNode = placeholder;
    if (index === lastIndex) data.endNode = previousSibling;
    entry.placeholder = placeholder;
  }

  if (lastEntries) {
    lastEntries.forEach(function (entry) {
      if (entry.available) {
        removeTemplate(entry.placeholder);
        entry.placeholder.parentNode.removeChild(entry.placeholder);
      }
    });
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90ZW1wbGF0ZS9yZXNvbHZlcnMvYXJyYXkuanMiXSwibmFtZXMiOlsiZGF0YU1hcCIsInJlbW92ZVRlbXBsYXRlIiwiZ2V0VGVtcGxhdGVFbmQiLCJyZXNvbHZlVmFsdWUiLCJhcnJheU1hcCIsIldlYWtNYXAiLCJtb3ZlUGxhY2Vob2xkZXIiLCJ0YXJnZXQiLCJwcmV2aW91c1NpYmxpbmciLCJkYXRhIiwiZ2V0Iiwic3RhcnROb2RlIiwiZW5kTm9kZSIsInBhcmVudE5vZGUiLCJpbnNlcnRCZWZvcmUiLCJuZXh0U2libGluZyIsInByZXZOb2RlIiwibm9kZSIsIm5leHROb2RlIiwicmVzb2x2ZUFycmF5IiwiaG9zdCIsInZhbHVlIiwibGFzdEVudHJpZXMiLCJlbnRyaWVzIiwibWFwIiwiaXRlbSIsImluZGV4IiwiaWQiLCJPYmplY3QiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJwbGFjZWhvbGRlciIsImF2YWlsYWJsZSIsInNldCIsImlkcyIsIlNldCIsImZvckVhY2giLCJlbnRyeSIsImFkZCIsImZpbHRlciIsImhhcyIsInJlbW92ZUNoaWxkIiwibGFzdEluZGV4IiwibGVuZ3RoIiwibWF0Y2hlZEVudHJ5IiwiaSIsImRvY3VtZW50IiwiY3JlYXRlVGV4dE5vZGUiXSwibWFwcGluZ3MiOiJBQUFBLFNBQ0VBLE9BREYsRUFDV0MsY0FEWCxFQUMyQkMsY0FEM0IsUUFFTyxVQUZQLEMsQ0FJQTs7QUFDQSxPQUFPQyxZQUFQLE1BQXlCLFNBQXpCO0FBRUEsT0FBTyxJQUFNQyxRQUFRLEdBQUcsSUFBSUMsT0FBSixFQUFqQjs7QUFFUCxTQUFTQyxlQUFULENBQXlCQyxNQUF6QixFQUFpQ0MsZUFBakMsRUFBa0Q7QUFDaEQsTUFBTUMsSUFBSSxHQUFHVCxPQUFPLENBQUNVLEdBQVIsQ0FBWUgsTUFBWixDQUFiO0FBQ0EsTUFBTUksU0FBUyxHQUFHRixJQUFJLENBQUNFLFNBQXZCO0FBQ0EsTUFBTUMsT0FBTyxH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TixLQUFLLEtBQUssQ0FBZCxFQUFpQmpCLElBQUksQ0FBQ0UsU0FBTCxHQUFpQnFCLFdBQWpCO0FBQ2pCLFFBQUlOLEtBQUssS0FBS2lCLFNBQWQsRUFBeUJsQyxJQUFJLENBQUNHLE9BQUwsR0FBZUosZUFBZjtBQUV6QjhCLElBQUFBLEtBQUssQ0FBQ04sV0FBTixHQUFvQkEsV0FBcEI7QUFDRDs7QUFFRCxNQUFJVixXQUFKLEVBQWlCO0FBQ2ZBLElBQUFBLFdBQVcsQ0FBQ2UsT0FBWixDQUFvQixVQUFDQyxLQUFELEVBQVc7QUFDN0IsVUFBSUEsS0FBSyxDQUFDTCxTQUFWLEVBQXFCO0FBQ25CaEMsUUFBQUEsY0FBYyxDQUFDcUMsS0FBSyxDQUFDTixXQUFQLENBQWQ7QUFDQU0sUUFBQUEsS0FBSyxDQUFDTixXQUFOLENBQWtCbkIsVUFBbEIsQ0FBNkI2QixXQUE3QixDQUF5Q0osS0FBSyxDQUFDTixXQUEvQztBQUNEO0FBQ0YsS0FMRDtBQU1EO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBkYXRhTWFwLCByZW1vdmVUZW1wbGF0ZSwgZ2V0VGVtcGxhdGVFbmQsXG59IGZyb20gJy4uL3V0aWxzJztcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGltcG9ydC9uby1jeWNsZVxuaW1wb3J0IHJlc29sdmVWYWx1ZSBmcm9tICcuL3ZhbHVlJztcblxuZXhwb3J0IGNvbnN0IGFycmF5TWFwID0gbmV3IFdlYWtNYXAoKTtcblxuZnVuY3Rpb24gbW92ZVBsYWNlaG9sZGVyKHRhcmdldCwgcHJldmlvdXNTaWJsaW5nKSB7XG4gIGNvbnN0IGRhdGEgPSBkYXRhTWFwLmdldCh0YXJnZXQpO1xuICBjb25zdCBzdGFydE5vZGUgPSBkYXRhLnN0YXJ0Tm9kZTtcbiAgY29uc3QgZW5kTm9kZSA9IGdldFRlbXBsYXRlRW5kKGRhdGEuZW5kTm9kZSk7XG5cbiAgcHJldmlvdXNTaWJsaW5nLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRhcmdldCwgcHJldmlvdXNTaWJsaW5nLm5leHRTaWJsaW5nKTtcblxuICBsZXQgcHJldk5vZGUgPSB0YXJnZXQ7XG4gIGxldCBub2RlID0gc3RhcnROb2RlO1xuICB3aGlsZSAobm9kZSkge1xuICAgIGNvbnN0IG5leHROb2RlID0gbm9kZS5uZXh0U2libGluZztcbiAgICBwcmV2Tm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShub2RlLCBwcmV2Tm9kZS5uZXh0U2libGluZyk7XG4gICAgcHJldk5vZGUgPSBub2RlO1xuICAgIG5vZGUgPSBuZXh0Tm9kZSAhPT0gZW5kTm9kZS5uZXh0U2libGluZyAmJiBuZXh0Tm9kZTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiByZXNvbHZlQXJyYXkoaG9zdCwgdGFyZ2V0LCB2YWx1ZSkge1xuICBsZXQgbGFzdEVudHJpZXMgPSBhcnJheU1hcC5nZXQodGFyZ2V0KTtcbiAgY29uc3QgZW50cmllcyA9IHZhbHVlLm1hcCgoaXRlbSwgaW5kZXgpID0+ICh7XG4gICAgaWQ6IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChpdGVtLCAnaWQnKSA/IGl0ZW0uaWQgOiBpbmRleCxcbiAgICB2YWx1ZTogaXRlbSxcbiAgICBwbGFjZWhvbGRlcjogbnVsbCxcbiAgICBhdmFpbGFibGU6IHRydWUsXG4gIH0pKTtcblxuICBhcnJheU1hcC5zZXQodGFyZ2V0LCBlbnRyaWVzKTtcblxuICBpZiAobGFzdEVudHJpZXMpIHtcbiAgICBjb25zdCBpZHMgPSBuZXcgU2V0KCk7XG4gICAgZW50cmllcy5mb3JFYWNoKGVudHJ5ID0+IGlkcy5hZGQoZW50cnkuaWQpKTtcblxuICAgIGxhc3RFbnRyaWVzID0gbGFzdEVudHJpZXMuZmlsdGVyKChlbnRyeSkgPT4ge1xuICAgICAgaWYgKCFpZHMuaGFzKGVudHJ5LmlkKSkge1xuICAgICAgICByZW1vdmVUZW1wbGF0ZShlbnRyeS5wbGFjZWhvbGRlcik7XG4gICAgICAgIGVudHJ5LnBsYWNlaG9sZGVyLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZW50cnkucGxhY2Vob2xkZXIpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0pO1xuICB9XG5cbiAgbGV0IHByZXZpb3VzU2libGluZyA9IHRhcmdldDtcbiAgY29uc3QgbGFzdEluZGV4ID0gdmFsdWUubGVuZ3RoIC0gMTtcbiAgY29uc3QgZGF0YSA9IGRhdGFNYXAuZ2V0KHRhcmdldCk7XG5cbiAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGVudHJpZXMubGVuZ3RoOyBpbmRleCArPSAxKSB7XG4gICAgY29uc3QgZW50cnkgPSBlbnRyaWVzW2luZGV4XTtcbiAgICBsZXQgbWF0Y2hlZEVudHJ5O1xuICAgIGlmIChsYXN0RW50cmllcykge1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsYXN0RW50cmllcy5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICBpZiAobGFzdEVudHJpZXNbaV0uYXZhaWxhYmxlICYmIGxhc3RFbnRyaWVzW2ldLmlkID09PSBlbnRyeS5pZCkge1xuICAgICAgICAgIG1hdGNoZWRFbnRyeSA9IGxhc3RFbnRyaWVzW2ldO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IHBsYWNlaG9sZGVyO1xuICAgIGlmIChtYXRjaGVkRW50cnkpIHtcbiAgICAgIG1hdGNoZWRFbnRyeS5hdmFpbGFibGUgPSBmYWxzZTtcbiAgICAgIHBsYWNlaG9sZGVyID0gbWF0Y2hlZEVudHJ5LnBsYWNlaG9sZGVyO1xuXG4gICAgICBpZiAocGxhY2Vob2xkZXIucHJldmlvdXNTaWJsaW5nICE9PSBwcmV2aW91c1NpYmxpbmcpIHtcbiAgICAgICAgbW92ZVBsYWNlaG9sZGVyKHBsYWNlaG9sZGVyLCBwcmV2aW91c1NpYmxpbmcpO1xuICAgICAgfVxuICAgICAgaWYgKG1hdGNoZWRFbnRyeS52YWx1ZSAhPT0gZW50cnkudmFsdWUpIHtcbiAgICAgICAgcmVzb2x2ZVZhbHVlKGhvc3QsIHBsYWNlaG9sZGVyLCBlbnRyeS52YWx1ZSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHBsYWNlaG9sZGVyID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJycpO1xuICAgICAgcHJldmlvdXNTaWJsaW5nLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHBsYWNlaG9sZGVyLCBwcmV2aW91c1NpYmxpbmcubmV4dFNpYmxpbmcpO1xuICAgICAgcmVzb2x2ZVZhbHVlKGhvc3QsIHBsYWNlaG9sZGVyLCBlbnRyeS52YWx1ZSk7XG4gICAgfVxuXG4gICAgcHJldmlvdXNTaWJsaW5nID0gZ2V0VGVtcGxhdGVFbmQoZGF0YU1hcC5nZXQocGxhY2Vob2xkZXIpLmVuZE5vZGUgfHwgcGxhY2Vob2xkZXIpO1xuXG4gICAgaWYgKGluZGV4ID09PSAwKSBkYXRhLnN0YXJ0Tm9kZSA9IHBsYWNlaG9sZGVyO1xuICAgIGlmIChpbmRleCA9PT0gbGFzdEluZGV4KSBkYXRhLmVuZE5vZGUgPSBwcmV2aW91c1NpYmxpbmc7XG5cbiAgICBlbnRyeS5wbGFjZWhvbGRlciA9IHBsYWNlaG9sZGVyO1xuICB9XG5cbiAgaWYgKGxhc3RFbnRyaWVzKSB7XG4gICAgbGFzdEVudHJpZXMuZm9yRWFjaCgoZW50cnkpID0+IHtcbiAgICAgIGlmIChlbnRyeS5hdmFpbGFibGUpIHtcbiAgICAgICAgcmVtb3ZlVGVtcGxhdGUoZW50cnkucGxhY2Vob2xkZXIpO1xuICAgICAgICBlbnRyeS5wbGFjZWhvbGRlci5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVudHJ5LnBsYWNlaG9sZGVyKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuIl19