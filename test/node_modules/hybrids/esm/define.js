function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === "object" || typeof call === "function")) { return call; } return _assertThisInitialized(self); }

function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }

function _wrapNativeSuper(Class) { var _cache = typeof Map === "function" ? new Map() : undefined; _wrapNativeSuper = function _wrapNativeSuper(Class) { if (Class === null || !_isNativeFunction(Class)) return Class; if (typeof Class !== "function") { throw new TypeError("Super expression must either be null or a function"); } if (typeof _cache !== "undefined") { if (_cache.has(Class)) return _cache.get(Class); _cache.set(Class, Wrapper); } function Wrapper() { return _construct(Class, arguments, _getPrototypeOf(this).constructor); } Wrapper.prototype = Object.create(Class.prototype, { constructor: { value: Wrapper, enumerable: false, writable: true, configurable: true } }); return _setPrototypeOf(Wrapper, Class); }; return _wrapNativeSuper(Class); }

function isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }

function _construct(Parent, args, Class) { if (isNativeReflectConstruct()) { _construct = Reflect.construct; } else { _construct = function _construct(Parent, args, Class) { var a = [null]; a.push.apply(a, args); var Constructor = Function.bind.apply(Parent, a); var instance = new Constructor(); if (Class) _setPrototypeOf(instance, Class.prototype); return instance; }; } return _construct.apply(null, arguments); }

function _isNativeFunction(fn) { return Function.toString.call(fn).indexOf("[native code]") !== -1; }

function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }

function _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

import property from './property';
import render from './render';
import * as cache from './cache';
import { pascalToDash, deferred } from './utils';
/* istanbul ignore next */

try {
  process.env.NODE_ENV;
} catch (e) {
  var process = {
    env: {
      NODE_ENV: 'production'
    }
  };
} // eslint-disable-line


var defaultMethod = function defaultMethod(host, value) {
  return value;
};

function compile(Hybrid, descriptors) {
  Hybrid.hybrids = descriptors;
  Hybrid.callbacks = [];
  Object.keys(descriptors).forEach(function (key) {
    var desc = descriptors[key];

    var type = _typeof(desc);

    var config;

    if (type === 'function') {
      config = key === 'render' ? render(desc) : {
        get: desc
      };
    } else if (type !== 'object' || desc === null || Array.isArray(desc)) {
      config = property(desc);
    } else {
      config = {
        get: desc.get || defaultMethod,
        set: desc.set || !desc.get && defaultMethod || undefined,
        connect: desc.connect,
        observe: desc.observe
      };
    }

    Object.defineProperty(Hybrid.prototype, key, {
      get: function get() {
        return cache.get(this, key, config.get);
      },
      set: config.set && function set(newValue) {
        cache.set(this, key, config.set, newValue);
      },
      enumerable: true,
      configurable: process.env.NODE_ENV !== 'production'
    });

    if (config.connect) {
      Hybrid.callbacks.push(function (host) {
        return config.connect(host, key, function () {
          cache.invalidate(host, key);
        });
      });
    }

    if (config.observe) {
      Hybrid.callbacks.push(function (host) {
        var lastValue;
        return cache.observe(host, key, function () {
          var value = host[key];

          if (value !== lastValue) {
            config.observe(host, value, lastValue);
            lastValue = value;
          }
        });
      });
    }
  });
}

var update;
/* istanbul ignore else */

if (process.env.NODE_ENV !== 'production') {
  var walkInShadow = function walkInShadow(node, fn) {
    fn(node);
    Array.from(node.children).forEach(function (el) {
      return walkInShadow(el, fn);
    });

    if (node.shadowRoot) {
      Array.from(node.shadowRoot.children).forEach(function (el) {
        return walkInShadow(el, fn);
      });
    }
  };

  var updateQueue = new Map();

  update = function update(Hybrid, lastHybrids) {
    if (!updateQueue.size) {
      deferred.then(function () {
        walkInShadow(document.body, function (node) {
          if (updateQueue.has(node.constructor)) {
            var hybrids = updateQueue.get(node.constructor);
            node.disconnectedCallback();
            Object.keys(node.constructor.hybrids).forEach(function (key) {
              cache.invalidate(node, key, node[key] === hybrids[key]);
            });
            node.connectedCallback();
          }
        });
        updateQueue.clear();
      });
    }

    updateQueue.set(Hybrid, lastHybrids);
  };
}

var disconnects = new WeakMap();

function defineElement(tagName, hybridsOrConstructor) {
  var type = _typeof(hybridsOrConstructor);

  if (type !== 'object' && type !== 'function') {
    throw TypeError("Second argument must be an object or a function: ".concat(type));
  }

  var CustomElement = window.customElements.get(tagName);

  if (type === 'function') {
    if (CustomElement !== hybridsOrConstructor) {
      return window.customElements.define(tagName, hybridsOrConstructor);
    }

    return CustomElement;
  }

  if (CustomElement) {
    if (CustomElement.hybrids === hybridsOrConstructor) {
      return CustomElement;
    }

    if (process.env.NODE_ENV !== 'production' && CustomElement.hybrids) {
      Object.keys(CustomElement.hybrids).forEach(function (key) {
        delete CustomElement.prototype[key];
      });
      var lastHybrids = CustomElement.hybrids;
      compile(CustomElement, hybridsOrConstructor);
      update(CustomElement, lastHybrids);
      return CustomElement;
    }

    throw Error("Element '".concat(tagName, "' already defined"));
  }

  var Hybrid =
  /*#__PURE__*/
  function (_HTMLElement) {
    _inherits(Hybrid, _HTMLElement);

    function Hybrid() {
      _classCallCheck(this, Hybrid);

      return _possibleConstructorReturn(this, _getPrototypeOf(Hybrid).apply(this, arguments));
    }

    _createClass(Hybrid, [{
      key: "connectedCallback",
      value: function connectedCallback() {
        var callbacks = this.constructor.callbacks;
        var list = [];

        for (var index = 0; index < callbacks.length; index += 1) {
          var cb = callbacks[index](this);
          if (cb) list.push(cb);
        }

        disconnects.set(this, list);
      }
    }, {
      key: "disconnectedCallback",
      value: function disconnectedCallback() {
        var list = disconnects.get(this);

        for (var index = 0; index < list.length; index += 1) {
          list[index]();
        }
      }
    }], [{
      key: "name",
      get: function get() {
        return tagName;
      }
    }]);

    return Hybrid;
  }(_wrapNativeSuper(HTMLElement));

  compile(Hybrid, hybridsOrConstructor);
  customElements.define(tagName, Hybrid);
  return Hybrid;
}

function defineMap(elements) {
  return Object.keys(elements).reduce(function (acc, key) {
    var tagName = pascalToDash(key);
    acc[key] = defineElement(tagName, elements[key]);
    return acc;
  }, {});
}

export default function define() {
  if (_typeof(arguments.length <= 0 ? undefined : arguments[0]) === 'object') {
    return defineMap(arguments.length <= 0 ? undefined : arguments[0]);
  }

  return defineElement.apply(void 0, arguments);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9kZWZpbmUuanMiXSwibmFtZXMiOlsicHJvcGVydHkiLCJyZW5kZXIiLCJjYWNoZSIsInBhc2NhbFRvRGFzaCIsImRlZmVycmVkIiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwiZSIsImRlZmF1bHRNZXRob2QiLCJob3N0IiwidmFsdWUiLCJjb21waWxlIiwiSHlicmlkIiwiZGVzY3JpcHRvcnMiLCJoeWJyaWRzIiwiY2FsbGJhY2tzIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJrZXkiLCJkZXNjIiwidHlwZSIsImNvbmZpZyIsImdldCIsIkFycmF5IiwiaXNBcnJheSIsInNldCIsInVuZGVmaW5lZCIsImNvbm5lY3QiLCJvYnNlcnZlIiwiZGVmaW5lUHJvcGVydHkiLCJwcm90b3R5cGUiLCJuZXdWYWx1ZSIsImVudW1lcmFibGUiLCJjb25maWd1cmFibGUiLCJwdXNoIiwiaW52YWxpZGF0ZSIsImxhc3RWYWx1ZSIsInVwZGF0ZSIsIndhbGtJblNoYWRvdyIsIm5vZGUiLCJmbiIsImZyb20iLCJjaGlsZHJlbiIsImVsIiwic2hhZG93Um9vdCIsInVwZGF0ZVF1ZXVlIiwiTWFwIiwibGFzdEh5YnJpZHMiLCJzaXplIiwidGhlbiIsImRvY3VtZW50IiwiYm9keSIsImhhcyIsImNvbnN0cnVjdG9yIiwiZGlzY29ubmVjdGVkQ2FsbGJhY2siLCJjb25uZWN0ZWRDYWxsYmFjayIsImNsZWFyIiwiZGlzY29ubmVjdHMiLCJXZWFrTWFwIiwiZGVmaW5lRWxlbWVudCIsInRhZ05hbWUiLCJoeWJyaWRzT3JDb25zdHJ1Y3RvciIsIlR5cGVFcnJvciIsIkN1c3RvbUVsZW1lbnQiLCJ3aW5kb3ciLCJjdXN0b21FbGVtZW50cyIsImRlZmluZSIsIkVycm9yIiwibGlzdCIsImluZGV4IiwibGVuZ3RoIiwiY2IiLCJIVE1MRWxlbWVudCIsImRlZmluZU1hcCIsImVsZW1lbnRzIiwicmVkdWNlIiwiYWNjIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7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QSwwQkFvQ2hDO0FBQUUsZUFBT1QsT0FBUDtBQUFpQjtBQXBDYTs7QUFBQTtBQUFBLHFCQW1DL0JZLFdBbkMrQjs7QUEwRHBEOUQsRUFBQUEsT0FBTyxDQUFDQyxNQUFELEVBQVNrRCxvQkFBVCxDQUFQO0FBQ0FJLEVBQUFBLGNBQWMsQ0FBQ0MsTUFBZixDQUFzQk4sT0FBdEIsRUFBK0JqRCxNQUEvQjtBQUVBLFNBQU9BLE1BQVA7QUFDRDs7QUFFRCxTQUFTOEQsU0FBVCxDQUFtQkMsUUFBbkIsRUFBNkI7QUFDM0IsU0FBTzNELE1BQU0sQ0FBQ0MsSUFBUCxDQUFZMEQsUUFBWixFQUFzQkMsTUFBdEIsQ0FBNkIsVUFBQ0MsR0FBRCxFQUFNMUQsR0FBTixFQUFjO0FBQ2hELFFBQU0wQyxPQUFPLEdBQUczRCxZQUFZLENBQUNpQixHQUFELENBQTVCO0FBQ0EwRCxJQUFBQSxHQUFHLENBQUMxRCxHQUFELENBQUgsR0FBV3lDLGFBQWEsQ0FBQ0MsT0FBRCxFQUFVYyxRQUFRLENBQUN4RCxHQUFELENBQWxCLENBQXhCO0FBRUEsV0FBTzBELEdBQVA7QUFDRCxHQUxNLEVBS0osRUFMSSxDQUFQO0FBTUQ7O0FBRUQsZUFBZSxTQUFTVixNQUFULEdBQXlCO0FBQ3RDLE1BQUksOERBQW1CLFFBQXZCLEVBQWlDO0FBQy9CLFdBQU9PLFNBQVMsa0RBQWhCO0FBQ0Q7O0FBRUQsU0FBT2QsYUFBYSxNQUFiLG1CQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcHJvcGVydHkgZnJvbSAnLi9wcm9wZXJ0eSc7XG5pbXBvcnQgcmVuZGVyIGZyb20gJy4vcmVuZGVyJztcblxuaW1wb3J0ICogYXMgY2FjaGUgZnJvbSAnLi9jYWNoZSc7XG5pbXBvcnQgeyBwYXNjYWxUb0Rhc2gsIGRlZmVycmVkIH0gZnJvbSAnLi91dGlscyc7XG5cbi8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG50cnkgeyBwcm9jZXNzLmVudi5OT0RFX0VOViB9IGNhdGNoKGUpIHsgdmFyIHByb2Nlc3MgPSB7IGVudjogeyBOT0RFX0VOVjogJ3Byb2R1Y3Rpb24nIH0gfTsgfSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG5cbmNvbnN0IGRlZmF1bHRNZXRob2QgPSAoaG9zdCwgdmFsdWUpID0+IHZhbHVlO1xuXG5mdW5jdGlvbiBjb21waWxlKEh5YnJpZCwgZGVzY3JpcHRvcnMpIHtcbiAgSHlicmlkLmh5YnJpZHMgPSBkZXNjcmlwdG9ycztcbiAgSHlicmlkLmNhbGxiYWNrcyA9IFtdO1xuXG4gIE9iamVjdC5rZXlzKGRlc2NyaXB0b3JzKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICBjb25zdCBkZXNjID0gZGVzY3JpcHRvcnNba2V5XTtcbiAgICBjb25zdCB0eXBlID0gdHlwZW9mIGRlc2M7XG5cbiAgICBsZXQgY29uZmlnO1xuXG4gICAgaWYgKHR5cGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGNvbmZpZyA9IGtleSA9PT0gJ3JlbmRlcicgPyByZW5kZXIoZGVzYykgOiB7IGdldDogZGVzYyB9O1xuICAgIH0gZWxzZSBpZiAodHlwZSAhPT0gJ29iamVjdCcgfHwgZGVzYyA9PT0gbnVsbCB8fCAoQXJyYXkuaXNBcnJheShkZXNjKSkpIHtcbiAgICAgIGNvbmZpZyA9IHByb3BlcnR5KGRlc2MpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25maWcgPSB7XG4gICAgICAgIGdldDogZGVzYy5nZXQgfHwgZGVmYXVsdE1ldGhvZCxcbiAgICAgICAgc2V0OiBkZXNjLnNldCB8fCAoIWRlc2MuZ2V0ICYmIGRlZmF1bHRNZXRob2QpIHx8IHVuZGVmaW5lZCxcbiAgICAgICAgY29ubmVjdDogZGVzYy5jb25uZWN0LFxuICAgICAgICBvYnNlcnZlOiBkZXNjLm9ic2VydmUsXG4gICAgICB9O1xuICAgIH1cblxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShIeWJyaWQucHJvdG90eXBlLCBrZXksIHtcbiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkge1xuICAgICAgICByZXR1cm4gY2FjaGUuZ2V0KHRoaXMsIGtleSwgY29uZmlnLmdldCk7XG4gICAgICB9LFxuICAgICAgc2V0OiBjb25maWcuc2V0ICYmIGZ1bmN0aW9uIHNldChuZXdWYWx1ZSkge1xuICAgICAgICBjYWNoZS5zZXQodGhpcywga2V5LCBjb25maWcuc2V0LCBuZXdWYWx1ZSk7XG4gICAgICB9LFxuICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgIGNvbmZpZ3VyYWJsZTogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyxcbiAgICB9KTtcblxuICAgIGlmIChjb25maWcuY29ubmVjdCkge1xuICAgICAgSHlicmlkLmNhbGxiYWNrcy5wdXNoKGhvc3QgPT4gY29uZmlnLmNvbm5lY3QoaG9zdCwga2V5LCAoKSA9PiB7XG4gICAgICAgIGNhY2hlLmludmFsaWRhdGUoaG9zdCwga2V5KTtcbiAgICAgIH0pKTtcbiAgICB9XG5cbiAgICBpZiAoY29uZmlnLm9ic2VydmUpIHtcbiAgICAgIEh5YnJpZC5jYWxsYmFja3MucHVzaCgoaG9zdCkgPT4ge1xuICAgICAgICBsZXQgbGFzdFZhbHVlO1xuICAgICAgICByZXR1cm4gY2FjaGUub2JzZXJ2ZShob3N0LCBrZXksICgpID0+IHtcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IGhvc3Rba2V5XTtcbiAgICAgICAgICBpZiAodmFsdWUgIT09IGxhc3RWYWx1ZSkge1xuICAgICAgICAgICAgY29uZmlnLm9ic2VydmUoaG9zdCwgdmFsdWUsIGxhc3RWYWx1ZSk7XG4gICAgICAgICAgICBsYXN0VmFsdWUgPSB2YWx1ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn1cblxubGV0IHVwZGF0ZTtcbi8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovXG5pZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykge1xuICBjb25zdCB3YWxrSW5TaGFkb3cgPSAobm9kZSwgZm4pID0+IHtcbiAgICBmbihub2RlKTtcblxuICAgIEFycmF5LmZyb20obm9kZS5jaGlsZHJlbilcbiAgICAgIC5mb3JFYWNoKGVsID0+IHdhbGtJblNoYWRvdyhlbCwgZm4pKTtcblxuICAgIGlmIChub2RlLnNoYWRvd1Jvb3QpIHtcbiAgICAgIEFycmF5LmZyb20obm9kZS5zaGFkb3dSb290LmNoaWxkcmVuKVxuICAgICAgICAuZm9yRWFjaChlbCA9PiB3YWxrSW5TaGFkb3coZWwsIGZuKSk7XG4gICAgfVxuICB9O1xuXG4gIGNvbnN0IHVwZGF0ZVF1ZXVlID0gbmV3IE1hcCgpO1xuICB1cGRhdGUgPSAoSHlicmlkLCBsYXN0SHlicmlkcykgPT4ge1xuICAgIGlmICghdXBkYXRlUXVldWUuc2l6ZSkge1xuICAgICAgZGVmZXJyZWQudGhlbigoKSA9PiB7XG4gICAgICAgIHdhbGtJblNoYWRvdyhkb2N1bWVudC5ib2R5LCAobm9kZSkgPT4ge1xuICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZS5oYXMobm9kZS5jb25zdHJ1Y3RvcikpIHtcbiAgICAgICAgICAgIGNvbnN0IGh5YnJpZHMgPSB1cGRhdGVRdWV1ZS5nZXQobm9kZS5jb25zdHJ1Y3Rvcik7XG4gICAgICAgICAgICBub2RlLmRpc2Nvbm5lY3RlZENhbGxiYWNrKCk7XG5cbiAgICAgICAgICAgIE9iamVjdC5rZXlzKG5vZGUuY29uc3RydWN0b3IuaHlicmlkcykuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgICAgICAgIGNhY2hlLmludmFsaWRhdGUobm9kZSwga2V5LCBub2RlW2tleV0gPT09IGh5YnJpZHNba2V5XSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbm9kZS5jb25uZWN0ZWRDYWxsYmFjaygpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHVwZGF0ZVF1ZXVlLmNsZWFyKCk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgdXBkYXRlUXVldWUuc2V0KEh5YnJpZCwgbGFzdEh5YnJpZHMpO1xuICB9O1xufVxuXG5jb25zdCBkaXNjb25uZWN0cyA9IG5ldyBXZWFrTWFwKCk7XG5cbmZ1bmN0aW9uIGRlZmluZUVsZW1lbnQodGFnTmFtZSwgaHlicmlkc09yQ29uc3RydWN0b3IpIHtcbiAgY29uc3QgdHlwZSA9IHR5cGVvZiBoeWJyaWRzT3JDb25zdHJ1Y3RvcjtcbiAgaWYgKHR5cGUgIT09ICdvYmplY3QnICYmIHR5cGUgIT09ICdmdW5jdGlvbicpIHtcbiAgICB0aHJvdyBUeXBlRXJyb3IoYFNlY29uZCBhcmd1bWVudCBtdXN0IGJlIGFuIG9iamVjdCBvciBhIGZ1bmN0aW9uOiAke3R5cGV9YCk7XG4gIH1cblxuICBjb25zdCBDdXN0b21FbGVtZW50ID0gd2luZG93LmN1c3RvbUVsZW1lbnRzLmdldCh0YWdOYW1lKTtcblxuICBpZiAodHlwZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIGlmIChDdXN0b21FbGVtZW50ICE9PSBoeWJyaWRzT3JDb25zdHJ1Y3Rvcikge1xuICAgICAgcmV0dXJuIHdpbmRvdy5jdXN0b21FbGVtZW50cy5kZWZpbmUodGFnTmFtZSwgaHlicmlkc09yQ29uc3RydWN0b3IpO1xuICAgIH1cbiAgICByZXR1cm4gQ3VzdG9tRWxlbWVudDtcbiAgfVxuXG4gIGlmIChDdXN0b21FbGVtZW50KSB7XG4gICAgaWYgKEN1c3RvbUVsZW1lbnQuaHlicmlkcyA9PT0gaHlicmlkc09yQ29uc3RydWN0b3IpIHtcbiAgICAgIHJldHVybiBDdXN0b21FbGVtZW50O1xuICAgIH1cbiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBDdXN0b21FbGVtZW50Lmh5YnJpZHMpIHtcbiAgICAgIE9iamVjdC5rZXlzKEN1c3RvbUVsZW1lbnQuaHlicmlkcykuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgIGRlbGV0ZSBDdXN0b21FbGVtZW50LnByb3RvdHlwZVtrZXldO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGxhc3RIeWJyaWRzID0gQ3VzdG9tRWxlbWVudC5oeWJyaWRzO1xuXG4gICAgICBjb21waWxlKEN1c3RvbUVsZW1lbnQsIGh5YnJpZHNPckNvbnN0cnVjdG9yKTtcbiAgICAgIHVwZGF0ZShDdXN0b21FbGVtZW50LCBsYXN0SHlicmlkcyk7XG5cbiAgICAgIHJldHVybiBDdXN0b21FbGVtZW50O1xuICAgIH1cblxuICAgIHRocm93IEVycm9yKGBFbGVtZW50ICcke3RhZ05hbWV9JyBhbHJlYWR5IGRlZmluZWRgKTtcbiAgfVxuXG4gIGNsYXNzIEh5YnJpZCBleHRlbmRzIEhUTUxFbGVtZW50IHtcbiAgICBzdGF0aWMgZ2V0IG5hbWUoKSB7IHJldHVybiB0YWdOYW1lOyB9XG5cbiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHtcbiAgICAgIGNvbnN0IHsgY2FsbGJhY2tzIH0gPSB0aGlzLmNvbnN0cnVjdG9yO1xuICAgICAgY29uc3QgbGlzdCA9IFtdO1xuXG4gICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgY2FsbGJhY2tzLmxlbmd0aDsgaW5kZXggKz0gMSkge1xuICAgICAgICBjb25zdCBjYiA9IGNhbGxiYWNrc1tpbmRleF0odGhpcyk7XG4gICAgICAgIGlmIChjYikgbGlzdC5wdXNoKGNiKTtcbiAgICAgIH1cblxuICAgICAgZGlzY29ubmVjdHMuc2V0KHRoaXMsIGxpc3QpO1xuICAgIH1cblxuICAgIGRpc2Nvbm5lY3RlZENhbGxiYWNrKCkge1xuICAgICAgY29uc3QgbGlzdCA9IGRpc2Nvbm5lY3RzLmdldCh0aGlzKTtcbiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBsaXN0Lmxlbmd0aDsgaW5kZXggKz0gMSkge1xuICAgICAgICBsaXN0W2luZGV4XSgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNvbXBpbGUoSHlicmlkLCBoeWJyaWRzT3JDb25zdHJ1Y3Rvcik7XG4gIGN1c3RvbUVsZW1lbnRzLmRlZmluZSh0YWdOYW1lLCBIeWJyaWQpO1xuXG4gIHJldHVybiBIeWJyaWQ7XG59XG5cbmZ1bmN0aW9uIGRlZmluZU1hcChlbGVtZW50cykge1xuICByZXR1cm4gT2JqZWN0LmtleXMoZWxlbWVudHMpLnJlZHVjZSgoYWNjLCBrZXkpID0+IHtcbiAgICBjb25zdCB0YWdOYW1lID0gcGFzY2FsVG9EYXNoKGtleSk7XG4gICAgYWNjW2tleV0gPSBkZWZpbmVFbGVtZW50KHRhZ05hbWUsIGVsZW1lbnRzW2tleV0pO1xuXG4gICAgcmV0dXJuIGFjYztcbiAgfSwge30pO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBkZWZpbmUoLi4uYXJncykge1xuICBpZiAodHlwZW9mIGFyZ3NbMF0gPT09ICdvYmplY3QnKSB7XG4gICAgcmV0dXJuIGRlZmluZU1hcChhcmdzWzBdKTtcbiAgfVxuXG4gIHJldHVybiBkZWZpbmVFbGVtZW50KC4uLmFyZ3MpO1xufVxuIl19